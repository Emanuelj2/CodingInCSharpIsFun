@{
    ViewData["Title"] = "Chat Home";
}

<div class="container mt-5">
    <h1 class="text-center mb-4">SignalR Chat Application</h1>

    <div class="row">
        <div class="col-md-4 mb-3">
            <div class="card">
                <div class="card-body text-center">
                    <h5 class="card-title">Public Chat</h5>
                    <p class="card-text">Join the public chat room and talk with everyone</p>
                    <button class="btn btn-primary" onclick="startPublicChat()">Start Public Chat</button>
                </div>
            </div>
        </div>

        <div class="col-md-4 mb-3">
            <div class="card">
                <div class="card-body text-center">
                    <h5 class="card-title">Private Messages</h5>
                    <p class="card-text">Send direct messages to specific users</p>
                    <a href="/Home/PrivateChat" class="btn btn-success">Open Private Chat</a>
                </div>
            </div>
        </div>

        <div class="col-md-4 mb-3">
            <div class="card">
                <div class="card-body text-center">
                    <h5 class="card-title">Group Chat</h5>
                    <p class="card-text">Create or join group conversations</p>
                    <a href="/Home/GroupChat" class="btn btn-info">Open Group Chat</a>
                </div>
            </div>
        </div>
    </div>

    <div id="publicChatSection" style="display:none;" class="mt-4">
        <div class="card">
            <div class="card-header">
                <h4>Public Chat Room</h4>
            </div>
            <div class="card-body">
                <div id="messagesList" class="border p-3 mb-3" style="height: 400px; overflow-y: auto;"></div>
                <div class="input-group">
                    <input type="text" id="userInput" class="form-control" placeholder="Your name" />
                    <input type="text" id="messageInput" class="form-control" placeholder="Type a message..." />
                    <button class="btn btn-primary" id="sendButton">Send</button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <script>
        let connection;

        function startPublicChat() {
            document.getElementById('publicChatSection').style.display = 'block';

            connection = new signalR.HubConnectionBuilder()
                .withUrl("/chatHub")
                .configureLogging(signalR.LogLevel.Information)
                .build();

            connection.on("ReceiveMessage", function (user, message) {
                const msg = document.createElement("div");
                msg.className = "mb-2";
                msg.innerHTML = `<strong>${escapeHtml(user)}:</strong> ${escapeHtml(message)}`;
                document.getElementById("messagesList").appendChild(msg);
                document.getElementById("messagesList").scrollTop = document.getElementById("messagesList").scrollHeight;
            });

            // CRITICAL FIX: Wait for connection to start BEFORE attaching handlers
            connection.start()
                .then(() => {
                    console.log("✅ SignalR Connected!");
                    // Now attach the event handlers
                    document.getElementById("sendButton").addEventListener("click", sendMessage);
                    document.getElementById("messageInput").addEventListener("keypress", function(e) {
                        if (e.key === 'Enter') sendMessage();
                    });
                })
                .catch(err => console.error("❌ Connection failed:", err.toString()));
        }

        function sendMessage() {
            const user = document.getElementById("userInput").value;
            const message = document.getElementById("messageInput").value;

            if (user && message) {
                // Check if connection is established
                if (connection.state === signalR.HubConnectionState.Connected) {
                    connection.invoke("SendMessage", user, message)
                        .then(() => {
                            console.log("✅ Message sent!");
                            document.getElementById("messageInput").value = '';
                        })
                        .catch(err => console.error("❌ Send failed:", err.toString()));
                } else {
                    console.error("❌ Not connected to SignalR hub");
                }
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
}